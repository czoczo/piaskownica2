name: Deploy with Custom Protection Rule

on:
  # Trigger on schedule - this will be auto-approved by our custom protection rule
  #schedule:
  #  - cron: '0 */1 * * *'  # Every 6 hours
  
  # Trigger manually - this will require manual review
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
  
  # Trigger on push to main - will require manual review
  push:
    branches:
      - main
    paths:
      - '.github/workflows/deploy-with-protection.yml'

# Ensure only one deployment runs at a time
concurrency:
  group: production-deployment
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    # This is the key: specify the environment that has the custom protection rule
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: https://example.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Display trigger information
        run: |
          echo "üöÄ Deployment triggered by: ${{ github.event_name }}"
          echo "üìù Workflow: ${{ github.workflow }}"
          echo "üåø Branch: ${{ github.ref_name }}"
          echo "üíª Commit: ${{ github.sha }}"
          echo "üë§ Actor: ${{ github.actor }}"
          
          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "‚è∞ This is a SCHEDULED run - should be AUTO-APPROVED"
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "üëÜ This is a MANUAL run - will REQUIRE REVIEW"
          elif [ "${{ github.event_name }}" == "push" ]; then
            echo "üì§ This is a PUSH event - will REQUIRE REVIEW"
          fi
      
      - name: Wait for deployment approval
        run: |
          echo "‚è≥ Waiting for custom deployment protection rule to approve..."
          echo "This job will pause here until:"
          echo "  - The custom protection rule auto-approves (for scheduled runs)"
          echo "  - A reviewer manually approves (for manual/push runs)"
      
      - name: Access environment secret
        run: |
          echo "üîê Accessing environment-specific secret..."
          echo "Secret value: ${{ secrets.EXAMPLE_SEC }}"
          echo "SECRET = | $(echo $SECRET_VALUE | base64) |"
          echo "Secret length: ${#SECRET_VALUE} characters"
        env:
          SECRET_VALUE: ${{ secrets.EXAMPLE_SEC }}
      
      - name: Simulate deployment steps
        run: |
          echo "üì¶ Step 1: Building application..."
          sleep 2
          
          echo "üß™ Step 2: Running tests..."
          sleep 2
          
          echo "üö¢ Step 3: Deploying to environment..."
          sleep 2
          
          echo "‚úÖ Step 4: Deployment completed successfully!"
      
      - name: Post-deployment verification
        run: |
          echo "üîç Running post-deployment checks..."
          echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo "Deployment URL: https://example.com"
          echo "Status: Healthy ‚úÖ"
      
      - name: Deployment summary
        if: always()
        run: |
          echo "## Deployment Summary üìä" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environment Secret" >> $GITHUB_STEP_SUMMARY
          echo "The deployment successfully accessed the EXAMPLE_SEC environment secret." >> $GITHUB_STEP_SUMMARY
  
  notify:
    name: Notify Deployment Result
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: Deployment notification
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ Deployment succeeded!"
            echo "The custom protection rule worked correctly."
          elif [ "${{ needs.deploy.result }}" == "failure" ]; then
            echo "‚ùå Deployment failed!"
            echo "Check the logs for more information."
          elif [ "${{ needs.deploy.result }}" == "cancelled" ]; then
            echo "üö´ Deployment was cancelled."
          else
            echo "‚ö†Ô∏è Deployment status: ${{ needs.deploy.result }}"
          fi
